---
title: "IRMS Data Reduction"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## How does this work?

1.  **Read and cache.** Our first step is to read in the raw .dxf files that are output from the IRMS instrument. These are large and unwieldy so our goal is to put them into an R-friendly data format. We read them in and do some cleanup using the `isoprocessor` and `isoreader` packages.

2.  **Quality control.** Next we remove files that are irrelevant to our analyses. This includes standards runs where we were doing instrument troubleshooting, Argon heating tests, cleaning blanks, etc.

3.  **Peak map**. Map compound identifications onto peaks based off of their retention time.

4.  **Export peak table**. Once we have our relevant standards and samples, we want to export them as a peak table such that we can begin our calibration process. This occurs in file `TBD`.

### Terminology

> A note on terminology throughout these scripts:
>
> -   `d2H` refers to the isotopic value of deuterium relative to VSMOW, expressed in units of permil.
>
> -   `R2H` refers to the isotopic ratio $^2R$ of deuterium
>
> -   `F2H` refers to the fractional abundance $^2F$ of deuterium
>
> -   `at2H` refers to the fractional abundance $^2F$ expressed in units of atom percent (at. %).
>
> The primary measurement for isotopic calculations is `F2H`. For some plots, `at2H` may be used, or `at2H.ppm` (atom fraction in ppm instead of percent) may be used, but these can be calculated on-the-spot in the ggplot with in-line operations.
>
> Isodat .dxf files output isotopic data in two formats: d2H in permil vs. VSMOW and at2H (at. %).

## Setup

```{r}
# the installation of these packages may be required
# uncomment below to install

#devtools::install_github("isoverse/isoprocessor")

#devtools::install_github("isoverse/isoreader")
```

Load the required packages

```{r}

rm(list=ls()) # Clear the environment

library(tidyverse)
library(isoprocessor)
library(isoreader)
library(isotopia)

message("Using isoreader version ", packageVersion("isoreader"))
message("Using isoprocessor version ", packageVersion("isoprocessor"))
```

### Import IRMS Data

```{r}
data_paths <- c(
  "data/GC-IRMS/raw_data/2023-09-05_PermafrostSet1_TAC_AEM/",
  "data/GC-IRMS/raw_data/2023-11-28_TAC-AEM_New-Reactor-Permafrost-FAMEs-Enriched/"
  )

# Define VSMOW values for 2R and 2F
ref_ratio <- get_standard("2H")
ref_frac <- to_abundance(ref_ratio)
R2H_VSMOW <- ref_ratio |> as.numeric()
F2H_VSMOW <- ref_frac |> as.numeric()


# this may take a while ....
  # so we will cache this for faster reading!
  # read files
iso_files_raw <- 
  # path to data files
  data_paths |> 
  # read data files in parallel for fast read
  iso_read_continuous_flow() |> 
  # filter out files with read errors (e.g. from aborted analysis)
  iso_filter_files_with_problems()
    
# Cache it!
write_rds(iso_files_raw, "cache/iso_files_raw.RDS")
```

### Import Peak Map and ignored injection list

```{r}
# this is a map of retention times for specific compounds across injections
peak_map <- readxl::read_excel(path = "data/GC-IRMS/IRMS_peak_map.xlsx")

# this is a list of analyses to ignore
ignored_analyses <- readxl::read_excel("data/GC-IRMS/ignored_injection_list.xlsx") |> pull(Analysis)
```

### Process IRMS data

```{r}
# process IRMS file information
iso_files <- iso_files_raw |> 
  # rename key file info columns
  iso_rename_file_info(
    analysis = Analysis, 
    id1 = `Identifier 1`,
    id2 = `Identifier 2`
    ) |> 
  # parse text info into numbers
  iso_parse_file_info(number = analysis) |> 
  iso_mutate_file_info(
    # what is the type of each analysis?
    type = case_when(
      str_detect(file_id, "[Zz]ero")      ~ "on_off",
      str_detect(file_id, "H3")           ~ "H3_factor",
      str_detect(file_id, "F8")           ~ "F8_std",
      str_detect(file_id, "FH_5")           ~ "FH5_std",
      str_detect(file_id, "FSH_9")           ~ "FSH9_std",
      str_detect(file_id, "blank")           ~ "blank",
      str_detect(file_id, "Blank")           ~ "blank",
      str_detect(file_id, "no inject")           ~ "blank",
      str_detect(file_id, "cleaning")           ~ "blank",
      str_detect(file_id, "BAME")           ~ "BAME",
      TRUE                            ~ "sample"
    ),
    # what was the concentration? (assuming Preparation = concentration or volume)
    concentration = 
      ifelse(type == "std",  
             str_extract(Preparation, "[0-9.]+ ?ng( per |/)uL") %>% 
               parse_number() %>% iso_double_with_units("ng/uL"),
             NA),
    # what folder are the data files in? (assuming folder = sequence)
    folder = basename(dirname(file_path))
  ) |> 
  iso_filter_files(!type %in% c("blank", "BAME", "H3_factor")) |>
  # focus only on the relevant file info, discarding the rest
  iso_select_file_info(folder, analysis, file_datetime, id1, type, concentration) |> 
  iso_set_peak_table_from_isodat_vendor_data_table() |> 
    # convert units from mV to V for amplitudes and area
    iso_convert_peak_table_units(V = mV, Vs = mVs)
```

### Plot an example chromatogram

```{r}
iso_files[100] |>  # choosing arbitrary file to plot
  iso_plot_continuous_flow_data(
    # select data and aesthetics
    data = c(2), color = id1, panel = id1,
    # zoom in on time interval
    time_interval = c(550, 1500),
    # peak labels for all peaks > 2V
    peak_bounds = TRUE,
    peak_marker = FALSE,
    peak_label = iso_format(rt),
    #peak_label_size = 3,
    peak_label_filter = analysis == 5685 & amp2 > 1
  ) +
    theme_classic() +
    theme(strip.background = element_blank())
```

### Inspect the file info

```{r}
iso_files |> 
  iso_get_file_info() |> 
  select(-file_id, -folder) |> 
  iso_make_units_explicit() |> 
  gt::gt() |> 
  gt::data_color(columns = type, palette = "Set1") 
```

### Generate peak table and export

```{r}
iso_peak_table <- iso_files |> 
  iso_get_peak_table() |> 
  # remove blanks, BAMEs, and H3s
  select(file_id, everything()) |> 
  mutate(
    Analysis = paste0("BF", str_extract(file_id, "(?<=BF)\\d{5}")),
    sample_id = str_replace(file_id, "BF\\d+|\\.dxf", ""),
    sample_id = str_replace(sample_id, ".dxf", ""),
    sample_id = str_replace(sample_id, "__", ""),
    rep = if_else(
      str_detect(file_id, "rep"),
      true = 2,
      false = 1
    )
  ) |> 
  select(file_id, Analysis, sample_id, rep, everything()) |> 
  mutate(
    type = case_when(
      str_detect(sample_id, "F8") ~ "F8",
      str_detect(sample_id, "FH_5") ~ "FH5",
      str_detect(sample_id, "FSH_9") ~ "FSH9",
      str_detect(sample_id, "F9") ~ "FSH9",
      TRUE ~ "sample"
    )
  ) |> 
  filter(!Analysis %in% ignored_analyses) # remove analyses we want to ignore

```

## Map peaks

```{r}
iso_peak_table_mapped <- iso_peak_table |> 
  iso_map_peaks(peak_map, map_id = Analysis)
```

Now we can inspect the mapped peak table

```{r}
# inspect samples
iso_peak_table_mapped |> pull(sample_id) |> unique()

# inspect compounds
iso_peak_table_mapped |> pull(compound) |> unique()
```

# Export

```{r}
# write .xlsx to data directory
iso_peak_table_mapped |> 
  writexl::write_xlsx(path = "data/GC-IRMS/iso_peak_table_mapped.xlsx")

# write .RDS to cache
iso_peak_table_mapped |> 
  write_rds(file = "cache/iso_peak_table_mapped.RDS")
```
